<!DOCTYPE html>


  <html class="light page-post">


<head>
  <meta charset="utf-8">
  
  <title>iOS3Då˜æ¢ä»¥åŠé€è§†ã€é˜´å½±è¯¦è§£ | Sugite</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="iOS,Core Animation," />
  

  <meta name="description" content="Backgroundæœ€è¿‘åœ¨å­¦ä¹ iOS Core Animationç›¸å…³çš„å†…å®¹ï¼Œç¬¬äº”ç« 3Då˜æ¢é‡Œæœ‰ä¸€ä¸ªDemoï¼Œæ˜¯åœ¨å±å¹•ä¸Šæ˜¾ç¤ºä¸€ä¸ªæ­£æ–¹ä½“ï¼Œå¹¶ä¸”ä¸ºå…¶æ·»åŠ å…‰ç…§é˜´å½±ï¼Œæ•ˆæœå›¾å¦‚ä¸‹æ‰€ç¤ºï¼š  Problemå¯ä»¥çœ‹åˆ°ï¼Œæœ€ç»ˆçš„æ•ˆæœè¿˜æ˜¯å¯ä»¥çš„ï¼Œä¹¦ä¸­ç»™å‡ºçš„ä»£ç å…·ä½“å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142">
<meta name="keywords" content="iOS,Core Animation">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS3Då˜æ¢ä»¥åŠé€è§†ã€é˜´å½±è¯¦è§£">
<meta property="og:url" content="http://www.dengbo.me/2017/09/08/iOS3Då˜æ¢ä»¥åŠé€è§†ã€é˜´å½±è¯¦è§£/index.html">
<meta property="og:site_name" content="Sugite">
<meta property="og:description" content="Backgroundæœ€è¿‘åœ¨å­¦ä¹ iOS Core Animationç›¸å…³çš„å†…å®¹ï¼Œç¬¬äº”ç« 3Då˜æ¢é‡Œæœ‰ä¸€ä¸ªDemoï¼Œæ˜¯åœ¨å±å¹•ä¸Šæ˜¾ç¤ºä¸€ä¸ªæ­£æ–¹ä½“ï¼Œå¹¶ä¸”ä¸ºå…¶æ·»åŠ å…‰ç…§é˜´å½±ï¼Œæ•ˆæœå›¾å¦‚ä¸‹æ‰€ç¤ºï¼š  Problemå¯ä»¥çœ‹åˆ°ï¼Œæœ€ç»ˆçš„æ•ˆæœè¿˜æ˜¯å¯ä»¥çš„ï¼Œä¹¦ä¸­ç»™å‡ºçš„ä»£ç å…·ä½“å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142">
<meta property="og:locale" content="zh-TW">
<meta property="og:image" content="http://7otic0.com1.z0.glb.clouddn.com/%E6%9C%AA%E5%91%BD%E5%90%8D%202.png">
<meta property="og:image" content="http://7otic0.com1.z0.glb.clouddn.com/%E5%9D%90%E6%A0%87%E7%B3%BB.png">
<meta property="og:image" content="http://7otic0.com1.z0.glb.clouddn.com/%E9%80%8F%E8%A7%86%E6%8A%95%E5%BD%B1.png">
<meta property="og:image" content="http://7otic0.com1.z0.glb.clouddn.com/perpective.png">
<meta property="og:image" content="http://7otic0.com1.z0.glb.clouddn.com/vector.png">
<meta property="og:updated_time" content="2017-09-08T09:33:18.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS3Då˜æ¢ä»¥åŠé€è§†ã€é˜´å½±è¯¦è§£">
<meta name="twitter:description" content="Backgroundæœ€è¿‘åœ¨å­¦ä¹ iOS Core Animationç›¸å…³çš„å†…å®¹ï¼Œç¬¬äº”ç« 3Då˜æ¢é‡Œæœ‰ä¸€ä¸ªDemoï¼Œæ˜¯åœ¨å±å¹•ä¸Šæ˜¾ç¤ºä¸€ä¸ªæ­£æ–¹ä½“ï¼Œå¹¶ä¸”ä¸ºå…¶æ·»åŠ å…‰ç…§é˜´å½±ï¼Œæ•ˆæœå›¾å¦‚ä¸‹æ‰€ç¤ºï¼š  Problemå¯ä»¥çœ‹åˆ°ï¼Œæœ€ç»ˆçš„æ•ˆæœè¿˜æ˜¯å¯ä»¥çš„ï¼Œä¹¦ä¸­ç»™å‡ºçš„ä»£ç å…·ä½“å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142">
<meta name="twitter:image" content="http://7otic0.com1.z0.glb.clouddn.com/%E6%9C%AA%E5%91%BD%E5%90%8D%202.png">

  

  
    <link rel="icon" href="/favicon.ico">
  

  <link href="/css/styles.css?v=c114cbe6" rel="stylesheet">


  
    <link rel="stylesheet" href="/css/personal-style.css">
  

  

  

  


  
    <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">
  
</head>

<body>


  
    <span id="toolbox-mobile" class="toolbox-mobile">è½»å¸Œ</span>
  

  <div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">è½»å¸Œ</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/archives/"
            rel="noopener noreferrer"
            target="_self"
            >
            åšå®¢
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/category/"
            rel="noopener noreferrer"
            target="_self"
            >
            åˆ†ç±»
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/tag/"
            rel="noopener noreferrer"
            target="_self"
            >
            æ ‡ç­¾
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/atom.xml"
            rel="noopener noreferrer"
            target="_blank"
            >
            RSS
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/search/"
            rel="noopener noreferrer"
            target="_self"
            >
            æœç´¢
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">Posts List</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Background"><span class="toc-text">Background</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Problem"><span class="toc-text">Problem</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Solve"><span class="toc-text">Solve</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ç¨‹åºæ— æ³•æ­£ç¡®è¿è¡Œ"><span class="toc-text">ç¨‹åºæ— æ³•æ­£ç¡®è¿è¡Œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3Då˜æ¢-amp-é€è§†æŠ•å½±"><span class="toc-text">3Då˜æ¢ & é€è§†æŠ•å½±</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#é½æ¬¡åæ ‡"><span class="toc-text">é½æ¬¡åæ ‡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ä»¿å°„å˜æ¢"><span class="toc-text">ä»¿å°„å˜æ¢</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#å¹³ç§»"><span class="toc-text">å¹³ç§»</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#æ—‹è½¬"><span class="toc-text">æ—‹è½¬</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ç¼©æ”¾"><span class="toc-text">ç¼©æ”¾</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#é€è§†æŠ•å½±"><span class="toc-text">é€è§†æŠ•å½±</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Display"><span class="toc-text">Display</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#æ­£æ–¹ä½“æ˜¾ç¤º"><span class="toc-text">æ­£æ–¹ä½“æ˜¾ç¤º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å…‰ç…§é˜´å½±æ•ˆæœ"><span class="toc-text">å…‰ç…§é˜´å½±æ•ˆæœ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-text">Reference</span></a></li></ol>
  </div>



<div class="content content-post CENTER">
   <article id="post-iOS3Då˜æ¢ä»¥åŠé€è§†ã€é˜´å½±è¯¦è§£" class="article article-type-post" itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">iOS3Då˜æ¢ä»¥åŠé€è§†ã€é˜´å½±è¯¦è§£</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2017.09.08</span>
      </span>

      
        <span class="article-author">
          <i class="icon-user"></i>
          <span>Sugite</span>
        </span>
      

      
  <span class="article-category">
    <i class="icon-list"></i>
    <a class="article-category-link" href="/categories/ğŸµ/">ğŸµ</a>
  </span>



      

      
      <i class="fa fa-eye"></i> 
        <span id="busuanzi_container_page_pv">
           &nbspçƒ­åº¦ <span id="busuanzi_value_page_pv">
           <i class="fa fa-spinner fa-spin"></i></span>â„ƒ
        </span>
      

      
      
    </div>
  </header>

  <div class="article-content">
    
      <h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>æœ€è¿‘åœ¨å­¦ä¹ iOS Core Animationç›¸å…³çš„å†…å®¹ï¼Œç¬¬äº”ç« 3Då˜æ¢é‡Œæœ‰ä¸€ä¸ªDemoï¼Œæ˜¯åœ¨å±å¹•ä¸Šæ˜¾ç¤ºä¸€ä¸ªæ­£æ–¹ä½“ï¼Œå¹¶ä¸”ä¸ºå…¶æ·»åŠ å…‰ç…§é˜´å½±ï¼Œæ•ˆæœå›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="http://7otic0.com1.z0.glb.clouddn.com/%E6%9C%AA%E5%91%BD%E5%90%8D%202.png" alt="æ•ˆæœå›¾"></p>
<h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>å¯ä»¥çœ‹åˆ°ï¼Œæœ€ç»ˆçš„æ•ˆæœè¿˜æ˜¯å¯ä»¥çš„ï¼Œä¹¦ä¸­ç»™å‡ºçš„ä»£ç å…·ä½“å¦‚ä¸‹ï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">"ViewController.h"</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;QuartzCore/QuartzCore.h&gt;</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;GLKit/GLKit.h&gt;</span></span></div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">#define LIGHT_DIRECTION 0, 1, -0.5</span></div><div class="line"><span class="meta">#define AMBIENT_LIGHT 0.5</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></div><div class="line"></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="keyword">IBOutlet</span> <span class="built_in">UIView</span> *containerView;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) IBOutletCollection(<span class="built_in">UIView</span>) <span class="built_in">NSArray</span> *faces;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)applyLightingToFace:(<span class="built_in">CALayer</span> *)face</div><div class="line">&#123;</div><div class="line">    <span class="comment">//add lighting layer</span></div><div class="line">    <span class="built_in">CALayer</span> *layer = [<span class="built_in">CALayer</span> layer];</div><div class="line">    layer.frame = face.bounds;</div><div class="line">    [face addSublayer:layer];</div><div class="line"></div><div class="line">    <span class="comment">//convert face transform to matrix</span></div><div class="line">    <span class="comment">//(GLKMatrix4 has the same structure as CATransform3D)</span></div><div class="line">    <span class="built_in">CATransform3D</span> transform = face.transform;</div><div class="line">    GLKMatrix4 matrix4 = *(GLKMatrix4 *)&amp;transform;</div><div class="line">    GLKMatrix3 matrix3 = GLKMatrix4GetMatrix3(matrix4);</div><div class="line"></div><div class="line">    <span class="comment">//get face normal</span></div><div class="line">    GLKVector3 normal = GLKVector3Make(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>);</div><div class="line">    normal = GLKMatrix3MultiplyVector3(matrix3, normal);</div><div class="line">    normal = GLKVector3Normalize(normal);</div><div class="line"></div><div class="line">    <span class="comment">//get dot product with light direction</span></div><div class="line">    GLKVector3 light = GLKVector3Normalize(GLKVector3Make(LIGHT_DIRECTION));</div><div class="line">    <span class="keyword">float</span> dotProduct = GLKVector3DotProduct(light, normal);</div><div class="line"></div><div class="line">    <span class="comment">//set lighting layer opacity</span></div><div class="line">    <span class="built_in">CGFloat</span> shadow = <span class="number">1</span> + dotProduct - AMBIENT_LIGHT;</div><div class="line">    <span class="built_in">UIColor</span> *color = [<span class="built_in">UIColor</span> colorWithWhite:<span class="number">0</span> alpha:shadow];</div><div class="line">    layer.backgroundColor = color.CGColor;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)addFace:(<span class="built_in">NSInteger</span>)index withTransform:(<span class="built_in">CATransform3D</span>)transform</div><div class="line">&#123;</div><div class="line">    <span class="comment">//get the face view and add it to the container</span></div><div class="line">    <span class="built_in">UIView</span> *face = <span class="keyword">self</span>.faces[index];</div><div class="line">    [<span class="keyword">self</span>.containerView addSubview:face];</div><div class="line"></div><div class="line">    <span class="comment">//center the face view within the container</span></div><div class="line">    <span class="built_in">CGSize</span> containerSize = <span class="keyword">self</span>.containerView.bounds.size;</div><div class="line">    face.center = <span class="built_in">CGPointMake</span>(containerSize.width / <span class="number">2.0</span>,</div><div class="line">                              containerSize.height / <span class="number">2.0</span>);</div><div class="line"></div><div class="line">    <span class="comment">//apply the transform</span></div><div class="line">    face.layer.transform = transform;</div><div class="line"></div><div class="line">    <span class="comment">//apply lighting</span></div><div class="line">    [<span class="keyword">self</span> applyLightingToFace:face.layer];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad</div><div class="line">&#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line"></div><div class="line">    <span class="comment">//set up the container sublayer transform</span></div><div class="line">    <span class="built_in">CATransform3D</span> perspective = <span class="built_in">CATransform3DIdentity</span>;</div><div class="line">    perspective.m34 = <span class="number">-1.0</span> / <span class="number">500.0</span>;</div><div class="line">    perspective = <span class="built_in">CATransform3DRotate</span>(perspective, -M_PI_4, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">    perspective = <span class="built_in">CATransform3DRotate</span>(perspective, -M_PI_4, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>);</div><div class="line">    <span class="keyword">self</span>.containerView.layer.sublayerTransform = perspective;</div><div class="line"></div><div class="line">    <span class="comment">//add cube face 1</span></div><div class="line">    <span class="built_in">CATransform3D</span> transform = <span class="built_in">CATransform3DMakeTranslation</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">100</span>);</div><div class="line">    [<span class="keyword">self</span> addFace:<span class="number">0</span> withTransform:transform];</div><div class="line"></div><div class="line">    <span class="comment">//add cube face 2</span></div><div class="line">    transform = <span class="built_in">CATransform3DMakeTranslation</span>(<span class="number">100</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">    transform = <span class="built_in">CATransform3DRotate</span>(transform, M_PI_2, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>);</div><div class="line">    [<span class="keyword">self</span> addFace:<span class="number">1</span> withTransform:transform];</div><div class="line"></div><div class="line">    <span class="comment">//add cube face 3</span></div><div class="line">    <span class="comment">//move this code after the setup for face no. 6 to enable button</span></div><div class="line">    transform = <span class="built_in">CATransform3DMakeTranslation</span>(<span class="number">0</span>, <span class="number">-100</span>, <span class="number">0</span>);</div><div class="line">    transform = <span class="built_in">CATransform3DRotate</span>(transform, M_PI_2, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">    [<span class="keyword">self</span> addFace:<span class="number">2</span> withTransform:transform];</div><div class="line"></div><div class="line">    <span class="comment">//add cube face 4</span></div><div class="line">    transform = <span class="built_in">CATransform3DMakeTranslation</span>(<span class="number">0</span>, <span class="number">100</span>, <span class="number">0</span>);</div><div class="line">    transform = <span class="built_in">CATransform3DRotate</span>(transform, -M_PI_2, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">    [<span class="keyword">self</span> addFace:<span class="number">3</span> withTransform:transform];</div><div class="line"></div><div class="line">    <span class="comment">//add cube face 5</span></div><div class="line">    transform = <span class="built_in">CATransform3DMakeTranslation</span>(<span class="number">-100</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">    transform = <span class="built_in">CATransform3DRotate</span>(transform, -M_PI_2, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>);</div><div class="line">    [<span class="keyword">self</span> addFace:<span class="number">4</span> withTransform:transform];</div><div class="line"></div><div class="line">    <span class="comment">//add cube face 6</span></div><div class="line">    transform = <span class="built_in">CATransform3DMakeTranslation</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">-100</span>);</div><div class="line">    transform = <span class="built_in">CATransform3DRotate</span>(transform, M_PI, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>);</div><div class="line">    [<span class="keyword">self</span> addFace:<span class="number">5</span> withTransform:transform];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>ä½†æ˜¯è¿è¡Œçš„æ—¶å€™å°±æœ‰ä¸¤ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li>ç¨‹åºæ— æ³•æ­£ç¡®è¿è¡Œ</li>
<li>å³ä½¿ç¨‹åºæ­£ç¡®è¿è¡Œï¼Œä¸ºä»€ä¹ˆä¼šäº§ç”Ÿæ•ˆæœå›¾é‚£ç§ç•Œé¢ï¼Œé‡Œé¢çš„å„ç§å˜æ¢æ˜¯å¦‚ä½•å®ç°çš„</li>
</ul>
<h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><h3 id="ç¨‹åºæ— æ³•æ­£ç¡®è¿è¡Œ"><a href="#ç¨‹åºæ— æ³•æ­£ç¡®è¿è¡Œ" class="headerlink" title="ç¨‹åºæ— æ³•æ­£ç¡®è¿è¡Œ"></a>ç¨‹åºæ— æ³•æ­£ç¡®è¿è¡Œ</h3><p>ç›´æ¥æŠŠä¹¦ä¸Šçš„æºç æ‹¿å‡ºæ¥ç¼–è¯‘è¿è¡Œçš„æ—¶å€™ï¼Œä¼šå‘ç°ç¨‹åºæ˜¾ç¤ºä¸€ç‰‡ç©ºç™½ï¼Œå¹¶æ²¡æœ‰åƒæ•ˆæœå›¾ä¸­é‚£æ ·ï¼Œç»è¿‡Debugå‘ç°ï¼Œé—®é¢˜åœ¨ä¸‹é¢è¿™è¡Œä»£ç ï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GLKMatrix4 matrix4 = *(GLKMatrix4 *)&amp;transform;</div></pre></td></tr></table></figure>
<p>è¿™å…¶ä¸­transformæ˜¯CATransform3Dç±»å‹çš„ï¼Œè¯¥ç±»å‹å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> <span class="built_in">CATransform3D</span></div><div class="line">&#123;</div><div class="line">  <span class="built_in">CGFloat</span> m11, m12, m13, m14;</div><div class="line">  <span class="built_in">CGFloat</span> m21, m22, m23, m24;</div><div class="line">  <span class="built_in">CGFloat</span> m31, m32, m33, m34;</div><div class="line">  <span class="built_in">CGFloat</span> m41, m42, m43, m44;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="built_in">CATransform3D</span> <span class="built_in">CATransform3D</span>;</div></pre></td></tr></table></figure>
<p>è€ŒCGFloatåœ¨64ä½ç¯å¢ƒä¸‹æ˜¯doubleï¼Œæ‰€ä»¥CATransform3Då®é™…ä¸Šæ˜¯æœ‰16ä¸ªdoubleå…ƒç´ çš„ç»“æ„ä½“ï¼Œè€ŒGLKMatrix4å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">union</span> _GLKMatrix4</div><div class="line">&#123;</div><div class="line">    <span class="keyword">struct</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">float</span> m00, m01, m02, m03;</div><div class="line">        <span class="keyword">float</span> m10, m11, m12, m13;</div><div class="line">        <span class="keyword">float</span> m20, m21, m22, m23;</div><div class="line">        <span class="keyword">float</span> m30, m31, m32, m33;</div><div class="line">    &#125;;</div><div class="line">    <span class="keyword">float</span> m[<span class="number">16</span>];</div><div class="line">&#125; __attribute__((aligned(<span class="number">16</span>)));</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">union</span> _GLKMatrix4 GLKMatrix4;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°å®ƒé‡Œé¢æ˜¯16ä¸ªfloatå…ƒç´ ï¼Œæ‰€ä»¥å¾ˆæ˜æ˜¾ï¼Œç›´æ¥å¯¹transformå–å€å†å¼ºè½¬ä¸ºGLKMatrix4ç±»å‹ä¼šå‘ç”Ÿæˆªæ–­é”™è¯¯ï¼Œå°†è¯¥è¡Œä»£ç æ”¹ä¸ºä¸‹é¢è¿™æ ·å³å¯ï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GLKMatrix4 matrix4 = GLKMatrix4Make(transform.m11, transform.m12, transform.m13, transform.m14, transform.m21, transform.m22, transform.m23, transform.m24, transform.m31, transform.m32, transform.m33, transform.m34, transform.m41, transform.m42, transform.m43, transform.m44);</div></pre></td></tr></table></figure>
<h3 id="3Då˜æ¢-amp-é€è§†æŠ•å½±"><a href="#3Då˜æ¢-amp-é€è§†æŠ•å½±" class="headerlink" title="3Då˜æ¢ &amp; é€è§†æŠ•å½±"></a>3Då˜æ¢ &amp; é€è§†æŠ•å½±</h3><h4 id="é½æ¬¡åæ ‡"><a href="#é½æ¬¡åæ ‡" class="headerlink" title="é½æ¬¡åæ ‡"></a>é½æ¬¡åæ ‡</h4><p><img src="http://7otic0.com1.z0.glb.clouddn.com/%E5%9D%90%E6%A0%87%E7%B3%BB.png" alt="åæ ‡ç³»"></p>
<p>é¦–å…ˆï¼Œåœ¨ä¸‰ç»´ç©ºé—´ä¸­ï¼Œå¯¹äºä¸€ä¸ªå‘é‡$v$ä»¥åŠåŸº$o-xyz$ï¼Œå¯ä»¥æ‰¾åˆ°ä¸€ç»„åæ ‡$(v_1,v_2,v_3)$ï¼Œä½¿å¾—</p>
<p>$$v = v_1x + v_2y + v_3z \tag{1}$$</p>
<p>è€Œå¯¹äºä¸€ä¸ªç‚¹pï¼Œåˆ™å¯ä»¥æ‰¾åˆ°ä¸€ç»„åæ ‡$(p_1,p_2,p_3)$ï¼Œä½¿å¾—</p>
<p>$$p-o = p_1x + p_2y + p_3z\tag{2}$$</p>
<p>ä»ä¸Šé¢å¯¹å‘é‡å’Œç‚¹çš„è¡¨è¾¾ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºä¸ºäº†åœ¨åæ ‡ç³»ä¸­è¡¨ç¤ºä¸€ä¸ªç‚¹ï¼ˆå¦‚pï¼‰ï¼Œæˆ‘ä»¬æŠŠç‚¹çš„ä½ç½®çœ‹ä½œæ˜¯å¯¹è¿™ä¸ªåŸºçš„åŸç‚¹oæ‰€è¿›è¡Œçš„ä¸€ä¸ªä½ç§»ï¼Œå³ä¸€ä¸ªå‘é‡(p-o)ï¼ˆæœ‰çš„ä¹¦ä¸­æŠŠè¿™æ ·çš„å‘é‡å«åšä½ç½®å‘é‡â€”â€”èµ·å§‹äºåæ ‡åŸç‚¹çš„ç‰¹æ®Šå‘é‡ï¼‰ï¼Œæˆ‘ä»¬åœ¨è¡¨è¾¾è¿™ä¸ªå‘é‡çš„åŒæ—¶ç”¨ç­‰ä»·çš„æ–¹å¼è¡¨è¾¾å‡ºäº†ç‚¹p:</p>
<p>$$p = o + p_1 x + p_2 y + p_3 z\tag{3}$$</p>
<p>(1)(3)æ˜¯åæ ‡ç³»ä¸‹è¡¨è¾¾ä¸€ä¸ªå‘é‡å’Œç‚¹çš„ä¸åŒè¡¨è¾¾æ–¹å¼ã€‚è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œè™½ç„¶éƒ½æ˜¯ç”¨ä»£æ•°åˆ†é‡çš„å½¢å¼è¡¨è¾¾å‘é‡å’Œç‚¹ï¼Œä½†è¡¨è¾¾ä¸€ä¸ªç‚¹æ¯”ä¸€ä¸ªå‘é‡éœ€è¦é¢å¤–çš„ä¿¡æ¯ã€‚å¦‚æœæˆ‘å†™å‡ºä¸€ä¸ªä»£æ•°åˆ†é‡è¡¨è¾¾$(1, 4, 7)$ï¼Œå¹¶ä¸èƒ½ç¡®å®šè¿™æ˜¯ä¸€ä¸ªç‚¹è¿˜æ˜¯ä¸€ä¸ªå‘é‡ã€‚</p>
<p>æˆ‘ä»¬ç°åœ¨æŠŠ(1)(3)å†™æˆçŸ©é˜µçš„å½¢å¼ï¼š</p>
<p>$$v=\begin{pmatrix} x &amp; y &amp; z &amp; o \\\end{pmatrix}\bullet\begin{pmatrix}v_1\\v_2\\v_3\\ 0\\\end{pmatrix}$$<br>$$p=\begin{pmatrix}x &amp; y &amp; z &amp; o \\\end{pmatrix}\bullet\begin{pmatrix}p_1\\p_2\\p_3\\1\\\end{pmatrix}$$</p>
<p>è¿™é‡Œ$(x,y,z,o)$æ˜¯åæ ‡åŸºçŸ©é˜µï¼Œå³è¾¹çš„åˆ—å‘é‡åˆ†åˆ«æ˜¯å‘é‡$v$å’Œç‚¹påœ¨åŸºä¸‹çš„åæ ‡ã€‚è¿™æ ·ï¼Œå‘é‡å’Œç‚¹åœ¨åŒä¸€ä¸ªåŸºä¸‹å°±æœ‰äº†ä¸åŒçš„è¡¨è¾¾ï¼š3Då‘é‡çš„ç¬¬4ä¸ªä»£æ•°åˆ†é‡æ˜¯0ï¼Œè€Œ3Dç‚¹çš„ç¬¬4ä¸ªä»£æ•°åˆ†é‡æ˜¯1ã€‚åƒè¿™ç§è¿™ç§ç”¨4ä¸ªä»£æ•°åˆ†é‡è¡¨ç¤º3Då‡ ä½•æ¦‚å¿µçš„æ–¹å¼æ˜¯ä¸€ç§é½æ¬¡åæ ‡è¡¨ç¤ºã€‚</p>
<p>å¯¹äºå¹³ç§»Tã€æ—‹è½¬Rã€ç¼©æ”¾Sè¿™3ä¸ªæœ€å¸¸è§çš„ä»¿å°„å˜æ¢ï¼Œå¹³ç§»å˜æ¢åªå¯¹äºç‚¹æ‰æœ‰æ„ä¹‰ï¼Œå› ä¸ºæ™®é€šå‘é‡æ²¡æœ‰ä½ç½®æ¦‚å¿µï¼Œåªæœ‰å¤§å°å’Œæ–¹å‘ï¼Œè¿™å¯ä»¥é€šè¿‡ä¸‹é¢çš„å¼å­æ¸…æ¥šåœ°çœ‹å‡ºï¼š</p>
<p>$$\begin{pmatrix}1&amp;0&amp;0&amp;tx\\0&amp;1&amp;0&amp;ty\\0&amp;0&amp;1&amp;tz\\0&amp;0&amp;0&amp;1\\\end{pmatrix}\bullet\begin{pmatrix}x\\y\\z\\1\\\end{pmatrix}=\begin{pmatrix}x+tx\\y+ty\\z+tz\\1\\\end{pmatrix}$$<br>$$\begin{pmatrix}1&amp;0&amp;0&amp;tx\\0&amp;1&amp;0&amp;ty\\0&amp;0&amp;1&amp;tz\\0&amp;0&amp;0&amp;1\\\end{pmatrix}\bullet\begin{pmatrix}x\\y\\z\\0\\\end{pmatrix}=\begin{pmatrix}x\\y\\z\\0\\\end{pmatrix}$$</p>
<p>è€Œæ—‹è½¬å’Œç¼©æ”¾å¯¹äºå‘é‡å’Œç‚¹éƒ½æœ‰æ„ä¹‰ï¼Œä½ å¯ä»¥ç”¨ç±»ä¼¼ä¸Šé¢é½æ¬¡è¡¨ç¤ºæ¥æ£€æµ‹ã€‚ä»ä¸­å¯ä»¥çœ‹å‡ºï¼Œé½æ¬¡åæ ‡ç”¨äºä»¿å°„å˜æ¢éå¸¸æ–¹ä¾¿ã€‚</p>
<h4 id="ä»¿å°„å˜æ¢"><a href="#ä»¿å°„å˜æ¢" class="headerlink" title="ä»¿å°„å˜æ¢"></a>ä»¿å°„å˜æ¢</h4><p>åŸºç¡€çš„ä»¿å°„å˜æ¢æœ‰å¹³ç§»ã€ç¼©æ”¾ã€æ—‹è½¬ä¸‰ç§ï¼Œä¸‹é¢æˆ‘ä»¬ä»¥ç‚¹ä¸ºä¾‹æ¥ç®€å•ä»‹ç»ä¸€ä¸‹è¿™ä¸‰ç§å˜æ¢å¯¹åº”çš„å˜æ¢çŸ©é˜µã€‚</p>
<h5 id="å¹³ç§»"><a href="#å¹³ç§»" class="headerlink" title="å¹³ç§»"></a>å¹³ç§»</h5><p>åœ¨ä¸‰ç»´é½æ¬¡åæ ‡è¡¨ç¤ºä¸­ï¼Œä»»æ„ç‚¹$P=(x,y,z)$é€šè¿‡å¹³ç§»è·ç¦»$t_x,t_y,t_z$åŠ åˆ°Pçš„åæ ‡ä¸Šè€Œå¹³ç§»åˆ°ä½ç½®$Pâ€™=(xâ€™,yâ€™,zâ€™)$ ï¼š</p>
<p>$$xâ€™=x+t_x,yâ€™=y+t_y,zâ€™=z+t_z$$</p>
<p>åœ¨è®¡ç®—æœºä¸­ï¼Œæˆ‘ä»¬ä¸ºäº†æ–¹ä¾¿ç¨‹åºå¤„ç†ï¼Œé€šå¸¸ç”¨çŸ©é˜µå½¢å¼æ¥è¡¨è¾¾ä¸‰ç»´å˜æ¢æ“ä½œï¼Œè¿™é‡Œï¼Œæˆ‘ä»¬ç”¨é½æ¬¡åæ ‡4å…ƒåˆ—å‘é‡çš„å½¢å¼è¡¨ç¤ºä½ç½®$På’ŒPâ€™$ï¼Œä¸”å˜æ¢æ“ä½œTæ˜¯4x4çŸ©é˜µï¼š</p>
<p>$$\begin{pmatrix}xâ€™\\yâ€™\\zâ€™\\1\\\end{pmatrix}ï¼\begin{pmatrix}1&amp;0&amp;0&amp;t_x\\0&amp;1&amp;0&amp;t_y\\0&amp;0&amp;1&amp;t_z\\0&amp;0&amp;0&amp;1\\\end{pmatrix}\bullet\begin{pmatrix}x\\y\\z\\1\\\end{pmatrix}$$</p>
<p>åœ¨ä¸‰ç»´ç©ºé—´ä¸­ï¼Œå¯¹è±¡çš„å¹³ç§»é€šè¿‡å¹³ç§»å®šä¹‰è¯¥å¯¹è±¡çš„å„ä¸ªç‚¹ç„¶ååœ¨æ–°ä½ç½®é‡å»ºè¯¥å¯¹è±¡è€Œå®ç°ã€‚å¯¹äºç”±ä¸€ç»„å¤šè¾¹å½¢è¡¨é¢è¡¨ç¤ºçš„å¯¹è±¡ï¼Œå¯ä»¥å°†å„ä¸ªè¡¨é¢çš„é¡¶ç‚¹è¿›è¡Œå¹³ç§»ï¼Œç„¶åé‡æ–°æ˜¾ç¤ºæ–°ä½ç½®çš„é¢ã€‚</p>
<h5 id="æ—‹è½¬"><a href="#æ—‹è½¬" class="headerlink" title="æ—‹è½¬"></a>æ—‹è½¬</h5><p>æˆ‘ä»¬å¯ä»¥ç»•ç©ºé—´çš„ä»»æ„è½´æ—‹è½¬ä¸€ä¸ªå¯¹è±¡ï¼Œä½†ç»•å¹³è¡Œäºåæ ‡è½´çš„è½´çš„æ—‹è½¬æ˜¯æœ€å®¹æ˜“å¤„ç†çš„ï¼Œé¦–å…ˆæˆ‘ä»¬æ¥çœ‹ç»•zè½´çš„æ—‹è½¬ï¼š</p>
<p>$$xâ€™=xcos\theta-ysin\theta\\yâ€™=xsin\theta+ycos\theta\\zâ€™=z$$</p>
<p>å‚æ•°$\theta$è¡¨ç¤ºæŒ‡å®šçš„ç»•zè½´æ—‹è½¬çš„è§’åº¦ï¼Œè€Œzåæ ‡å€¼åœ¨è¯¥å˜æ¢ä¸­ä¸å˜ã€‚ä¸‰ç»´zè½´æ—‹è½¬æ–¹ç¨‹å¯ä»¥ç”¨é½æ¬¡åæ ‡å½¢å¼è¡¨ç¤ºå¦‚ä¸‹ï¼š</p>
<p>$$\begin{pmatrix}xâ€™\\yâ€™\\zâ€™\\1\\\end{pmatrix}ï¼\begin{pmatrix}cos\theta&amp;-sin\theta&amp;0&amp;0\\sin\theta&amp;cos\theta&amp;0&amp;0\\0&amp;0&amp;1&amp;0\\0&amp;0&amp;0&amp;1\\\end{pmatrix}\bullet\begin{pmatrix}x\\y\\z\\1\\\end{pmatrix}$$</p>
<p>åŒç†ï¼Œå¯ä»¥å¾—åˆ°xè½´æ—‹è½¬å…¬å¼ï¼š</p>
<p>$$yâ€™=ycos\theta-zsin\theta\\zâ€™=ysin\theta+zcos\theta\\xâ€™=x$$</p>
<p>ä»¥åŠyè½´æ—‹è½¬å…¬å¼ï¼š</p>
<p>$$zâ€™=zcos\theta-xsin\theta\\xâ€™=zsin\theta+xcos\theta\\yâ€™=y$$</p>
<p>ç›¸åº”çš„æ—‹è½¬æ–¹ç¨‹å¦‚ä¸‹ï¼š</p>
<p>$$\begin{pmatrix}xâ€™\\yâ€™\\zâ€™\\1\\\end{pmatrix}ï¼\begin{pmatrix}1&amp;0&amp;0&amp;0\\0&amp;cos\theta&amp;-sin\theta&amp;0\\0&amp;sin\theta&amp;cos\theta&amp;0\\0&amp;0&amp;0&amp;1\\\end{pmatrix}\bullet\begin{pmatrix}x\\y\\z\\1\\\end{pmatrix}$$<br>$$\begin{pmatrix}xâ€™\\yâ€™\\zâ€™\\1\\\end{pmatrix}ï¼\begin{pmatrix}cos\theta&amp;0&amp;sin\theta&amp;0\\0&amp;1&amp;0&amp;0\\-sin\theta&amp;0&amp;cos\theta&amp;0\\0&amp;0&amp;0&amp;1\\\end{pmatrix}\bullet\begin{pmatrix}x\\y\\z\\1\\\end{pmatrix}$$</p>
<h5 id="ç¼©æ”¾"><a href="#ç¼©æ”¾" class="headerlink" title="ç¼©æ”¾"></a>ç¼©æ”¾</h5><p>ç¼©æ”¾æ¯”è¾ƒç®€å•ï¼Œè¿›è¡Œç®€å•çš„å„åæ ‡è½´æ–¹å‘ä¹˜ç§¯è¿ç®—å³å¯ï¼Œç¼©æ”¾æ–¹ç¨‹å¦‚ä¸‹ï¼š</p>
<p>$$\begin{pmatrix}xâ€™\\yâ€™\\zâ€™\\1\\\end{pmatrix}ï¼\begin{pmatrix}s_x&amp;0&amp;0&amp;0\\0&amp;s_y&amp;0&amp;0\\0&amp;0&amp;x_z&amp;0\\0&amp;0&amp;0&amp;1\\\end{pmatrix}\bullet\begin{pmatrix}x\\y\\z\\1\\\end{pmatrix}$$</p>
<h4 id="é€è§†æŠ•å½±"><a href="#é€è§†æŠ•å½±" class="headerlink" title="é€è§†æŠ•å½±"></a>é€è§†æŠ•å½±</h4><p>iOSä¸­çš„CALayerçš„3Dæœ¬è´¨ä¸Šå¹¶ä¸èƒ½ç®—çœŸæ­£çš„3D(å…¶è§†ç‚¹å³è§‚å¯Ÿç‚¹æˆ–è€…æ‰€è°“çš„ç…§ç›¸æœºçš„ä½ç½®æ˜¯æ— æ³•å˜æ¢çš„)ï¼Œè€Œåªæ˜¯3Dåœ¨äºŒç»´å¹³é¢ä¸Šçš„æŠ•å½±ï¼ŒæŠ•å½±å¹³é¢å°±æ˜¯æ‰‹æœºå±å¹•ä¹Ÿå°±æ˜¯xyè½´ç»„æˆçš„å¹³é¢(æ³¨æ„iOSä¸­ä¸ºå·¦æ‰‹åæ ‡ç³»)ï¼Œé‚£ä¹ˆè§†ç‚¹çš„ä½ç½®æ˜¯å¦‚ä½•ç¡®å®šçš„å‘¢ï¼Ÿå¯ä»¥é€šè¿‡CATransform3Dä¸­çš„$m_{34}$æ¥é—´æ¥æŒ‡å®šï¼Œ $m_{34} = -1/z$ï¼Œå…¶ä¸­$z$ä¸ºè§‚å¯Ÿç‚¹åœ¨zè½´ä¸Šçš„å€¼,è€ŒLayerçš„zè½´çš„ä½ç½®åˆ™æ˜¯é€šè¿‡anchorPointæ¥æŒ‡å®šçš„ï¼Œæ‰€è°“çš„anchorPoint(é”šç‚¹)å°±æ˜¯åœ¨å˜æ¢ä¸­ä¿æŒä¸å˜çš„ç‚¹ï¼Œä¹Ÿå°±æ˜¯æŸä¸ªLayeråœ¨å˜æ¢ä¸­çš„åŸç‚¹ï¼Œxyzä¸‰è½´ç›¸äº¤äºæ­¤ç‚¹ã€‚</p>
<p>$m_{34} = -1/z$ä¸­ï¼Œå½“$z$ä¸ºæ­£çš„æ—¶å€™ï¼Œæ˜¯æˆ‘ä»¬äººçœ¼è§‚å¯Ÿç°å®ä¸–ç•Œçš„æ•ˆæœï¼Œå³åœ¨æŠ•å½±å¹³é¢ä¸Šè¡¨ç°å‡ºè¿‘å¤§è¿œå°çš„æ•ˆæœï¼Œ$z$è¶Šé è¿‘åŸç‚¹åˆ™è¿™ç§æ•ˆæœè¶Šæ˜æ˜¾ï¼Œè¶Šè¿œç¦»åŸç‚¹åˆ™è¶Šæ¥è¶Šä¸æ˜æ˜¾ï¼Œå½“$z$ä¸ºæ­£æ— ç©·å¤§çš„æ—¶å€™ï¼Œåˆ™å¤±å»äº†è¿‘å¤§è¿œå°çš„æ•ˆæœï¼Œæ­¤æ—¶æŠ•å½±çº¿å‚ç›´äºæŠ•å½±å¹³é¢ï¼Œä¹Ÿå°±æ˜¯è§†ç‚¹åœ¨æ— ç©·è¿œå¤„ï¼ŒCATransform3Dä¸­$m_{34}$çš„é»˜è®¤å€¼ä¸º0ï¼Œå³è§†ç‚¹åœ¨æ— ç©·è¿œå¤„ã€‚</p>
<p>ä¸‹é¢ä»¥ç‚¹$P(10,0,-10)$ä¸ºä¾‹çœ‹ä¸€ä¸‹åœ¨iOSçš„é€è§†æŠ•å½±æœºåˆ¶ä¸­ï¼Œä¸‰ç»´ç©ºé—´ä¸Šçš„ä¸€ç‚¹æ˜¯å¦‚ä½•æŠ•å½±åˆ°æŠ•å½±å¹³é¢ï¼ˆæ‰‹æœºå±å¹•ï¼‰ä¸Šçš„ã€‚</p>
<p><img src="http://7otic0.com1.z0.glb.clouddn.com/%E9%80%8F%E8%A7%86%E6%8A%95%E5%BD%B1.png" alt="é€è§†æŠ•å½±"></p>
<p>å›¾ä¸­ç»¿è‰²ç‚¹ä¸ºç‚¹Pï¼Œè§†ç‚¹ä¸ºè§‚å¯Ÿç‚¹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬ä»è§†ç‚¹çš„ä½ç½®å»è§‚å¯ŸPç‚¹ï¼Œé‚£ä¹ˆè™šçº¿å°±ä¸ºæŠ•å½±çº¿ï¼Œå…¶ä¸xè½´çš„äº¤ç‚¹å³ä¸ºæŠ•å½±ç‚¹ï¼Œé€šè¿‡è®¾ç½®$m_{34}=-1/500$ï¼Œæˆ‘ä»¬å¾—åˆ°æŠ•å½±çŸ©é˜µå¦‚ä¸‹ï¼š</p>
<p>$$\begin{pmatrix}1&amp;0&amp;0&amp;0\\0&amp;1&amp;0&amp;0\\0&amp;0&amp;1&amp;0\\0&amp;0&amp;-\frac{1}{500}&amp;1\\\end{pmatrix}$$</p>
<p>å°†å…¶ä¸ç‚¹Pç›¸ä¹˜å¾—åˆ°ï¼š</p>
<p>$$\begin{pmatrix}1&amp;0&amp;0&amp;0\\0&amp;1&amp;0&amp;0\\0&amp;0&amp;1&amp;0\\0&amp;0&amp;-\frac{1}{500}&amp;1\\\end{pmatrix}\bullet\begin{pmatrix}10\\0\\-10\\1\end{pmatrix}=\begin{pmatrix}10\\0\\-10\\1.02\end{pmatrix}$$</p>
<p>å°†å¾—åˆ°çš„ç‚¹è½¬ä¸ºé½æ¬¡åæ ‡å³ä¸ºï¼š</p>
<p>$$\begin{pmatrix}10/1.02\\0\\-10/1.02\\1\end{pmatrix}$$</p>
<p>ä¸ä¸Šé¢å›¾ä¸­çš„ç¤ºæ„ç›¸åŒã€‚ç”±äºæ˜¯ç›´æ¥æŠ•å½±åˆ°xyå¹³é¢ï¼Œæ‰€ä»¥ç›´æ¥å°†zåæ ‡ç½®ä¸º0å³å¯ã€‚</p>
<h2 id="Display"><a href="#Display" class="headerlink" title="Display"></a>Display</h2><h3 id="æ­£æ–¹ä½“æ˜¾ç¤º"><a href="#æ­£æ–¹ä½“æ˜¾ç¤º" class="headerlink" title="æ­£æ–¹ä½“æ˜¾ç¤º"></a>æ­£æ–¹ä½“æ˜¾ç¤º</h3><p>ç®€å•è¯´å®Œä¸Šè¿°çš„åŸºæœ¬ç†è®ºï¼Œå†å›åˆ°é—®é¢˜ï¼Œçœ‹çœ‹å‰æ–‡ä»£ç ä¸­æ‰€æ„å»ºçš„æ­£æ–¹ä½“ä¸ºä½•åœ¨æ‰‹æœºå±å¹•ä¸Šæ˜¾ç¤ºä¸ºé‚£æ ·ã€‚</p>
<p>çœ‹ä»£ç å¯çŸ¥ï¼ŒDemoä¸­ä¸€å…±åˆå§‹åŒ–äº†6ä¸ªViewï¼Œåˆ†åˆ«å½“ä½œæ­£æ–¹ä½“çš„6é¢ï¼Œå…¶ä¸­æ¯ä¸€é¢åˆå§‹åŒ–çš„æ—¶å€™éƒ½è¿›è¡Œäº†å¹³ç§»å’Œæ—‹è½¬ï¼Œå¯ä»¥ç®€å•æƒ³è±¡ä¸€ä¸‹ï¼Œ6ä¸ªé¢ç»è¿‡å¹³ç§»æ—‹è½¬ï¼Œæ°å¥½åœ¨ä¸‰ç»´ç©ºé—´å†…æ„å»ºä¸ºä¸€ä¸ªæ­£æ–¹ä½“ï¼Œæ­£æ–¹ä½“ä¸­å¿ƒä¸ºåæ ‡åŸç‚¹ï¼Œè¾¹é•¿ä¸º200ï¼Œå…«ä¸ªé¡¶ç‚¹åæ ‡åˆ†åˆ«ä¸ºï¼š</p>
<p>$$(100,100,100)\\(100,100,-100)\\(100,-100,100)\\(100,-100,-100)\\(-100,100,100)\\(-100,100,-100)\\(-100,-100,100)\\(-100,-100,-100)$$</p>
<p>æ–¹ä¾¿èµ·è§ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“è¿™å…«ä¸ªç‚¹ç»è¿‡å„ç§å˜æ¢ååœ¨æŠ•å½±å¹³é¢çš„ä½ç½®å°±å¯ä»¥çŸ¥é“æ•´ä¸ªç«‹æ–¹ä½“çœ‹èµ·æ¥çš„æ•ˆæœã€‚</p>
<p>å†æ¥çœ‹çœ‹æ•´ä¸ªå®¹å™¨Viewè¿›è¡Œäº†å“ªäº›å˜æ¢ï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">CATransform3D</span> perspective = <span class="built_in">CATransform3DIdentity</span>;</div><div class="line">perspective.m34 = <span class="number">-1.0</span> / <span class="number">500.0</span>;</div><div class="line">perspective = <span class="built_in">CATransform3DRotate</span>(perspective, -M_PI_4, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">perspective = <span class="built_in">CATransform3DRotate</span>(perspective, -M_PI_4, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>);</div><div class="line"><span class="keyword">self</span>.containerView.layer.sublayerTransform = perspective;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œä¸ºäº†è¾¾åˆ°é€¼çœŸçš„æ•ˆæœï¼Œç¨‹åºé¦–å…ˆå°†$m_{34}$è¿›è¡Œäº†è®¾ç½®ï¼Œç„¶åå°†æ•´ä¸ªå›¾å±‚å…ˆç»•xè½´æ—‹è½¬$-45^\circ$ï¼Œå†ç»•yè½´æ—‹è½¬äº†$-45^\circ$ï¼Œè¿™æ ·ä¸€æ¥ï¼Œæœ€ç»ˆçš„å˜æ¢çŸ©é˜µperspectiveå³ä¸ºï¼š</p>
<p>$$<br>\begin{pmatrix}1&amp;0&amp;0&amp;0\\0&amp;1&amp;0&amp;0\\0&amp;0&amp;1&amp;0\\0&amp;0&amp;-\frac{1}{500}&amp;1\\\end{pmatrix}\bullet<br>\begin{pmatrix}<br>\frac{\sqrt 2}{2}&amp;0&amp;-\frac{\sqrt 2}{2}&amp;0\\<br>0&amp;1&amp;0&amp;0\\<br>\frac{\sqrt 2}{2}&amp;0&amp;\frac{\sqrt 2}{2}&amp;0\\<br>0&amp;0&amp;0&amp;1\\<br>\end{pmatrix}\bullet<br>\begin{pmatrix}1&amp;0&amp;0&amp;0\\<br>0&amp;\frac{\sqrt 2}{2}&amp;\frac{\sqrt 2}{2}&amp;0\\<br>0&amp;-\frac{\sqrt 2}{2}&amp;\frac{\sqrt 2}{2}&amp;0\\<br>0&amp;0&amp;0&amp;1\\\end{pmatrix}\\=<br>\begin{pmatrix}<br>\frac{\sqrt 2}{2}&amp;0&amp;-\frac{\sqrt 2}{2}&amp;0\\<br>\frac{1}{2}&amp;\frac{\sqrt 2}{2}&amp;\frac{1}{2}&amp;0\\<br>\frac{1}{2}&amp;-\frac{\sqrt 2}{2}&amp;\frac{1}{2}&amp;0\\<br>-\frac{1}{1000}&amp;\frac{\sqrt 2}{1000}&amp;-\frac{1}{1000}&amp;1\\<br>\end{pmatrix}=perspective<br>$$</p>
<p>å¾—åˆ°äº†å˜æ¢çŸ©é˜µï¼Œæˆ‘ä»¬å†å°†ä¸Šè¿°çš„å…«ä¸ªç‚¹ä¸€ä¸€ä¸çŸ©é˜µç›¸ä¹˜ï¼Œä¾¿èƒ½å¾—åˆ°å®ƒä»¬åœ¨æŠ•å½±å¹³é¢ä¸Šçš„ä½ç½®ï¼Œè¿™é‡Œä»¥$(100,100,100,1)$ä¸ºä¾‹ï¼š</p>
<p>$$<br>\begin{pmatrix}<br>\frac{\sqrt 2}{2}&amp;0&amp;-\frac{\sqrt 2}{2}&amp;0\\<br>\frac{1}{2}&amp;\frac{\sqrt 2}{2}&amp;\frac{1}{2}&amp;0\\<br>\frac{1}{2}&amp;-\frac{\sqrt 2}{2}&amp;\frac{1}{2}&amp;0\\<br>-\frac{1}{1000}&amp;\frac{\sqrt 2}{1000}&amp;-\frac{1}{1000}&amp;1\\<br>\end{pmatrix}\bullet<br>\begin{pmatrix}100\\100\\100\\1\\\end{pmatrix}=<br>\begin{pmatrix}0\\100+50\sqrt 2\\100-50\sqrt 2\\\frac{8+\sqrt 2}{10}\\\end{pmatrix}\to<br>\begin{pmatrix}0\\181.33\\0\\1\\\end{pmatrix}<br>$$</p>
<p>å…¶ä»–ä¸ƒä¸ªç‚¹è®¡ç®—å¦‚ä¸‹ï¼š</p>
<p>$$<br>(123.90,61.95,0,1)\\<br>(0,44.47,0,1)\\<br>(161.71,-82.36,0,1)\\<br>(-123.90,61.95,0,1)\\<br>(0,-21.83,0,1)\\<br>(-161.71,-82.36,0,1)\\<br>(0,-161.26,0,1)<br>$$</p>
<p>å°†ä¸Šè¿°å…«ä¸ªç‚¹åœ¨xyå¹³é¢ä¸Šç”»å‡ºæ¥å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://7otic0.com1.z0.glb.clouddn.com/perpective.png" alt="perpective"></p>
<p>æ˜¯ä¸æ˜¯è·Ÿå‰é¢æ•ˆæœå›¾ä¸­çš„ä¸€æ¨¡ä¸€æ ·å‘¢ã€‚è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»äº†è§£äº†ä¸‰ç»´ç©ºé—´ä¸­çš„å¯¹è±¡æ˜¯å¦‚ä½•ç»è¿‡ä¸€ç³»åˆ—å˜æ¢æŠ•å½±åˆ°æ‰‹æœºå±å¹•ä¸Šçš„ï¼Œä¸‹é¢ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹æ­£æ–¹ä½“ä¸åŒå¹³é¢çš„å…‰ç…§é˜´å½±æ˜¯å¦‚ä½•è®¡ç®—çš„ã€‚</p>
<h3 id="å…‰ç…§é˜´å½±æ•ˆæœ"><a href="#å…‰ç…§é˜´å½±æ•ˆæœ" class="headerlink" title="å…‰ç…§é˜´å½±æ•ˆæœ"></a>å…‰ç…§é˜´å½±æ•ˆæœ</h3><p>å…ˆæ¥çœ‹ä»£ç ï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)applyLightingToFace:(<span class="built_in">CALayer</span> *)face</div><div class="line">&#123;</div><div class="line">    <span class="comment">//add lighting layer</span></div><div class="line">    <span class="built_in">CALayer</span> *layer = [<span class="built_in">CALayer</span> layer];</div><div class="line">    layer.frame = face.bounds;</div><div class="line">    [face addSublayer:layer];</div><div class="line"></div><div class="line">    <span class="comment">//convert face transform to matrix</span></div><div class="line">    <span class="comment">//(GLKMatrix4 has the same structure as CATransform3D)</span></div><div class="line">    <span class="built_in">CATransform3D</span> transform = face.transform;</div><div class="line">    GLKMatrix4 matrix4 = *(GLKMatrix4 *)&amp;transform;</div><div class="line">    GLKMatrix3 matrix3 = GLKMatrix4GetMatrix3(matrix4);</div><div class="line"></div><div class="line">    <span class="comment">//get face normal</span></div><div class="line">    GLKVector3 normal = GLKVector3Make(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>);</div><div class="line">    normal = GLKMatrix3MultiplyVector3(matrix3, normal);</div><div class="line">    normal = GLKVector3Normalize(normal);</div><div class="line"></div><div class="line">    <span class="comment">//get dot product with light direction</span></div><div class="line">    GLKVector3 light = GLKVector3Normalize(GLKVector3Make(LIGHT_DIRECTION));</div><div class="line">    <span class="keyword">float</span> dotProduct = GLKVector3DotProduct(light, normal);</div><div class="line"></div><div class="line">    <span class="comment">//set lighting layer opacity</span></div><div class="line">    <span class="built_in">CGFloat</span> shadow = <span class="number">1</span> + dotProduct - AMBIENT_LIGHT;</div><div class="line">    <span class="built_in">UIColor</span> *color = [<span class="built_in">UIColor</span> colorWithWhite:<span class="number">0</span> alpha:shadow];</div><div class="line">    layer.backgroundColor = color.CGColor;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸Šè¿°ä»£ç åˆ†ä¸ºå‡ ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>å°†é½æ¬¡åæ ‡çš„4ç»´å˜æ¢çŸ©é˜µé™ä¸º3ç»´ï¼Œå› ä¸ºè¿™é‡Œæˆ‘ä»¬æ˜¯ç”¨çš„å¹³è¡Œå…‰ï¼Œä¸éœ€è¦å¹³ç§»ï¼Œè€ŒåŸå§‹å˜æ¢çŸ©é˜µçš„ç¬¬å››ç»´ä¸»è¦æ˜¯å¹³ç§»ä»¥åŠé€è§†æŠ•å½±ç”¨ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥ç”¨å‰3ç»´å³å¯ã€‚</li>
<li>è·å–ç…§å°„å¹³é¢çš„æ³•å‘é‡ã€‚å› ä¸ºæˆ‘ä»¬çš„æ¯ä¸ªé¢éƒ½æ˜¯ç”±åˆå§‹çš„å¹³è¡Œäºxyå¹³é¢çš„é¢ç»è¿‡ä¸€ç³»åˆ—å˜æ¢è€Œæ¥ï¼Œè€Œåˆå§‹å¹³é¢çš„æ³•å‘é‡æ˜¯$(0,0,1)$ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å°†åˆå§‹æ³•å‘é‡ç»è¿‡åŒæ ·çš„å˜æ¢ï¼Œå³å¯æ±‚å¾—ç…§å°„å¹³é¢çš„æ³•å‘é‡ã€‚</li>
<li>å°†å…‰ç…§å‘é‡ä¸ç…§å°„å¹³é¢æ³•å‘é‡åšç‚¹ç§¯è¿ç®—ï¼Œå³å¯æ±‚å¾—å…‰ç…§å‘é‡åœ¨ç…§å°„å¹³é¢çš„æŠ•å½±ï¼Œæ¨å¯¼å¦‚ä¸‹ï¼š</li>
</ol>
<p><img src="http://7otic0.com1.z0.glb.clouddn.com/vector.png" alt="vector"></p>
<p>å‡è®¾$u$åœ¨$v$ä¸Šçš„æŠ•å½±å‘é‡æ˜¯$uâ€™$ï¼Œä¸”å‘é‡$u$å’Œ$v$çš„å¤¹è§’ä¸º$\theta$ã€‚ä¸€ä¸ªå‘é‡æœ‰ä¸¤ä¸ªå±æ€§ï¼Œå¤§å°å’Œæ–¹å‘ï¼Œæˆ‘ä»¬å…ˆç¡®å®š$uâ€™$çš„å¤§å°ï¼ˆå³é•¿åº¦ï¼Œæˆ–è€…æ¨¡ï¼‰ï¼Œä»$u$çš„æœ«ç«¯åš$v$çš„å‚çº¿ï¼Œé‚£ä¹ˆ$d$å°±æ˜¯$uâ€™$çš„é•¿åº¦ã€‚è€Œ$uâ€™$å’Œ$v$çš„æ–¹å‘æ˜¯ç›¸åŒçš„ï¼Œ$v$çš„æ–¹å‘$v/|v|$ä¹Ÿå°±æ˜¯$uâ€™$çš„æ–¹å‘ã€‚æ‰€ä»¥æœ‰</p>
<p>$$uâ€™=d\frac{v}{|v|}\tag{1}$$</p>
<p>å†æ±‚$d$çš„é•¿åº¦</p>
<p>$$d=|u|cos\theta\tag{2}$$</p>
<p>æœ€åæ±‚$cos\theta$</p>
<p>$$cos\theta=\frac{u\cdot v}{|u||v|}\tag{3}$$</p>
<p>å¾—åˆ°</p>
<p>$$uâ€™=\frac{u\cdot v}{|v|^2}v$$</p>
<p>è¿™å°±æ˜¯æœ€ç»ˆçš„æŠ•å½±å‘é‡ï¼Œé•¿åº¦$d$åˆ™ä¸º</p>
<p>$$|uâ€™|=|u|cos\theta=|u|\frac{u\cdot v}{|u||v|}=\frac{u\cdot v}{|v|}$$</p>
<p>å› ä¸º$v$æ˜¯å•ä½å‘é‡ï¼Œé•¿åº¦ä¸ºä¸€ï¼Œæ‰€ä»¥æœ€ç»ˆçš„å…‰å¼ºååº”åœ¨ä»£ç ä¸­å°±æ˜¯ä¸¤ä¸ªå‘é‡åšç‚¹ç§¯ã€‚</p>
<p>è‡³æ­¤ï¼Œæ•´ä¸ªä»£ç éƒ½å·²ç»éå¸¸æ¸…æ¥šäº†ï¼Œå®Œã€‚</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://www.amazon.com/iOS-Core-Animation-Advanced-Techniques-ebook/dp/B00EHJCORC" target="_blank" rel="external">iOS Core Animation: Advanced Techniques</a></li>
<li><a href="https://www.amazon.com/Computer-Graphics-Open-GL-4th/dp/0136053580" target="_blank" rel="external">Computer Graphics with Open GL</a></li>
<li><a href="http://geeklu.com/2012/07/ios-3d-perspective/" target="_blank" rel="external">iOSçš„ä¸‰ç»´é€è§†æŠ•å½±</a></li>
<li><a href="http://blog.csdn.net/popy007/article/details/1797121" target="_blank" rel="external">æ·±å…¥æ¢ç´¢é€è§†æŠ•å½±å˜æ¢</a></li>
</ul>

    
  </div>
</article>


   

   
  <div class="box-prev-next clearfix">
    <a class="show pull-left" href="/2016/08/17/iOSä¸­çš„Hit-Testing/">
        <i class="icon icon-angle-left"></i>
    </a>
    <a class="hide pull-right" href="/">
        <i class="icon icon-angle-right"></i>
    </a>
  </div>




</div>


  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">Close</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/archives/"
              rel="noopener noreferrer"
              target="_self"
              >
              åšå®¢
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/category/"
              rel="noopener noreferrer"
              target="_self"
              >
              åˆ†ç±»
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/tag/"
              rel="noopener noreferrer"
              target="_self"
              >
              æ ‡ç­¾
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/atom.xml"
              rel="noopener noreferrer"
              target="_blank"
              >
              RSS
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/search/"
              rel="noopener noreferrer"
              target="_self"
              >
              æœç´¢
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    

    




    

    
	
  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235683', function() {
      // load success
    });
  }
</script>

</body>
</html>
